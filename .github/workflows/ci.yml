name: lab5-ci  # 工作流名称：截图里会显示这个名字

on:
  # 触发条件1：push 到 main 分支时自动运行
  push:
    branches: ["main"]

  # 触发条件2：对 main 分支发起 PR / 更新 PR 时自动运行
  pull_request:
    branches: ["main"]

  # 触发条件3：允许在 GitHub Actions 页面手动点击 Run workflow 触发
  workflow_dispatch:

jobs:
  test:
    name: run-tests-and-coverage
    runs-on: ubuntu-latest  # 使用 GitHub 提供的 Ubuntu Runner

    # 环境变量：让 pytest 能 import 到你的项目包（services/utils/models 等）
    env:
      PYTHONPATH: ${{ github.workspace }}

      # 若你在项目里“人为注入了 fuzz bug”，默认不要在 CI 打开
      LAB5_FUZZ_BUG: "0"

    steps:
      # Step 1：拉取仓库代码
      - name: Checkout
        uses: actions/checkout@v4

      # Step 2：设置 Python 版本（建议与你本地一致：3.12）
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"  # 关键：启用 pip 依赖缓存，加快后续运行

      # Step 3：安装依赖（requirements.txt）
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Step 4：运行单元测试 + 集成测试 + 覆盖率统计
      # 说明：
      # - 这里默认跑 tests 下全部测试（包括你加了 @pytest.mark.integration 的集成测试）
      # - 输出 term-missing 便于在 Actions 日志中查看覆盖率缺失行
      # - 如果你当前覆盖率尚未稳定达到 80%，先不要加 --cov-fail-under
      - name: Run pytest with coverage
        run: |
          python -m pytest -q \
            --cov=services --cov=utils \
            --cov-report=term-missing

      # Step 5（可选）：生成 html 覆盖率报告并上传为 artifacts，便于下载
      - name: Generate HTML coverage report
        run: |
          python -m pytest -q \
            --cov=services --cov=utils \
            --cov-report=html

      - name: Upload coverage html
        uses: actions/upload-artifact@v4
        with:
          name: htmlcov
          path: htmlcov